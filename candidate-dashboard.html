<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Candidate – BeyondMatch</title>

  <!-- Candidate-only theme -->
  <link rel="stylesheet" href="cand.css" />
</head>

<body>

<!-- SIDEBAR -->
<aside class="cand-sidebar">
  <h2 class="cand-brand">BeyondMatch</h2>
  <nav class="cand-menu">

    <a href="candidate-dashboard.html" class="cand-menu-item active">Dashboard</a>

    <a href="upload-jd.html" class="cand-menu-item">Job Descriptions</a>

    <a href="jobmatches.html" class="cand-menu-item">Job Matches</a>

    <a href="locatehire.html" class="cand-menu-item">LocateHire</a>

    <a href="settings.html" class="cand-menu-item">Settings</a>

    <a href="savedjobs.html" class="cand-menu-item">Saved Jobs</a>

    <button class="menu-item logout-btn" onclick="unifiedLogout()">
  ⏻ Logout
</button>

  </nav>
</aside>

<!-- MAIN -->
<main class="cand-main">

  <!-- PAGE TITLE -->
  <div class="cand-page-title">
    <h1>Add Candidate</h1>
    <p>Create a candidate profile and attach a resume for matching.</p>
  </div>

  <!-- 3-COLUMN GRID -->
  <div class="cand-grid">

    <!-- MIDDLE: POWER BI -->
    <div class="cand-card cand-powerbi">
      <h3>Candidate Insights Dashboard</h3>
      <iframe
        src="https://app.powerbi.com/view?r=eyJrIjoiZTMwMGM2ZmYtOWNmOS00OTFiLWFhYjgtMjY3ZTlhNmRhZmQzIiwidCI6IjljMTg1NzE0LWYwYWYtNDgyNi1iZDRiLTdiOTg3ZjZkZDkyMSJ9"
        allowfullscreen>
      </iframe>
    </div>

    <!-- RIGHT: ADD CANDIDATE -->
    <div class="cand-card cand-form">

      <form id="uploadCandidateForm">

        <div class="cand-input">
          <label>Full Name *</label>
          <input id="fullName" type="text" placeholder="John Doe" required />
        </div>

        <div class="cand-input">
          <label>Email *</label>
          <input id="email" type="email" placeholder="john@example.com" required />
        </div>

        <div class="cand-input">
          <label>Resume (PDF / DOCX)</label>
          <input type="file" id="resumeFile" accept=".pdf,.doc,.docx" />
          <textarea id="resumeText" hidden></textarea>
        </div>

        <button class="cand-btn" type="submit">Add Candidate</button>

        <!-- STATUS -->
        <div class="cand-status">
          <h4>Status</h4>
          <pre id="uploadCandidateResult">{}</pre>
        </div>

      </form>
    </div>

  </div>

</main>

<script type="module" src="auth.js"></script>
<script type="module" src="api.js"></script>
<script type="module" src="candidate.js"></script>

<script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
</script>

<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
<script>
document.getElementById("uploadCandidateForm").onsubmit = async (e) => {
  e.preventDefault();

  const name = document.getElementById("fullName").value;
  const email = document.getElementById("email").value;
  const resumeText = document.getElementById("resumeText").value;

  const result = await uploadCandidate(name, email, resumeText);

  document.getElementById("uploadCandidateResult").textContent =
    JSON.stringify(result, null, 2);
};
</script>
<script>
const resumeFileInput = document.getElementById("resumeFile");
const resumeTextArea = document.getElementById("resumeText");

resumeFileInput.addEventListener("change", async () => {
  const file = resumeFileInput.files[0];
  if (!file) return;

  const ext = file.name.split(".").pop().toLowerCase();

  resumeTextArea.value = "Parsing resume…";

  try {
    if (ext === "pdf") {
      await parsePDF(file);
    } else if (ext === "docx") {
      await parseDOCX(file);
    } else {
      alert("Unsupported file type");
      resumeTextArea.value = "";
    }
  } catch (err) {
    console.error(err);
    alert("Failed to parse resume");
    resumeTextArea.value = "";
  }
});

async function parsePDF(file) {
  const buffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;

  let text = "";
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(item => item.str).join(" ") + "\n";
  }

  resumeTextArea.value = text;
}

async function parseDOCX(file) {
  const buffer = await file.arrayBuffer();
  const result = await mammoth.extractRawText({ arrayBuffer: buffer });
  resumeTextArea.value = result.value;
}
</script>

</body>
</html>
